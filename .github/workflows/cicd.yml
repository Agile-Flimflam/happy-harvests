name: CI/CD Pipeline

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run lint
        run: pnpm lint

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run tests
        run: echo "âš  Skipping tests (no test files present)"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          ANALYZE: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: .next
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

      - name: Upload bundle analysis reports
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            .next/analyze/**
            .next/BUILD_ID
          retention-days: 30
          if-no-files-found: warn
          include-hidden-files: true

      - name: Generate bundle size summary
        run: |
          echo "## Bundle Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/analyze" ]; then
            echo "âœ… Bundle analysis completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Analysis reports are available in the bundle-analysis artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Bundle analysis directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Install Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Start Supabase
        run: |
          supabase start -x studio,migra,deno-relay --ignore-health-check
          # Export keys to GITHUB_ENV
          STATUS=$(supabase status -o json)
          echo "Supabase Status Output: $STATUS"

          API_URL=$(echo $STATUS | jq -r .API_URL)
          ANON_KEY=$(echo $STATUS | jq -r .ANON_KEY)
          SERVICE_KEY=$(echo $STATUS | jq -r .SERVICE_ROLE_KEY)

          if [ "$API_URL" == "null" ] || [ -z "$API_URL" ]; then
            echo "Error: Failed to extract Supabase API URL. Status output was: $STATUS"
            exit 1
          fi

          echo "NEXT_PUBLIC_SUPABASE_URL=$API_URL" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$ANON_KEY" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=$SERVICE_KEY" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SITE_URL=http://localhost:4000" >> $GITHUB_ENV

      - name: Build application
        run: pnpm build

      - name: Start Next.js server
        run: |
          pnpm start > server.log 2>&1 &
          echo $! > server.pid
        env:
          PORT: 4000

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:4000 > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i: Server not ready yet, waiting..."
            sleep 2
          done
          echo "Server failed to start. Logs:"
          cat server.log || true
          exit 1

      - name: Run E2E tests
        run: pnpm test:e2e --project=chromium
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4000

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            kill $PID 2>/dev/null || true
            sleep 2
            kill -9 $PID 2>/dev/null || true
            rm server.pid
          fi
          pkill -f "next start" || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: test-results/**/*.webm
          retention-days: 30

      - name: Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/**/*.png
          retention-days: 30

      - name: Sanitize server logs
        if: failure()
        run: |
          if [ -f server.log ]; then
            # Redact sensitive keys from logs
            sed -i "s|$NEXT_PUBLIC_SUPABASE_ANON_KEY|[REDACTED_ANON_KEY]|g" server.log
            sed -i "s|$SUPABASE_SERVICE_ROLE_KEY|[REDACTED_SERVICE_ROLE_KEY]|g" server.log
          fi

      - name: Upload server logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: server.log
          retention-days: 2

  deploy-db:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    needs: [test, build, e2e-tests]
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - uses: actions/checkout@v4

      - uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          version: latest

      - name: Push migrations to production
        run: supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

  check-sonar-secrets:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
    steps:
      - id: check
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
        run: |
          if [[ -n "$SONAR_TOKEN" && -n "$SONAR_PROJECT_KEY" && -n "$SONAR_ORGANIZATION" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
          fi

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [build, e2e-tests, check-sonar-secrets]
    continue-on-error: true
    if: needs.check-sonar-secrets.outputs.should-run == 'true' && success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectKey: ${{ secrets.SONAR_PROJECT_KEY }}
          organization: ${{ secrets.SONAR_ORGANIZATION }}

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret scanning
        uses: trufflesecurity/trufflehog@v3.90.13
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before }}
          head: HEAD
          github_token: ${{ secrets.GITHUB_TOKEN }}

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Vulnerability audit
        continue-on-error: true
        run: pnpm audit
