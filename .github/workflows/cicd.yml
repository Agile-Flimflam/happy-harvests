name: CI/CD Pipeline

# Note: If using tj-actions/changed-files in the future, it will automatically use
# the default GITHUB_TOKEN. The current permissions (contents: read) are sufficient
# for changed-files to function correctly without explicit token passing.

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: read

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run lint
        run: pnpm lint

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Run tests
        run: pnpm test

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage/
          retention-days: 1
          if-no-files-found: warn

  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          # Uses a specific version of the Supabase CLI to ensure reproducibility
          version: 2.62.5

      - name: Start Supabase
        run: |
          # Exclude inbucket to avoid port 54324 conflicts on GitHub runners
          supabase start -x inbucket

      - name: Validate migrations
        run: supabase db reset --yes

      - name: Stop Supabase
        if: ${{ always() }}
        run: |
          if command -v supabase >/dev/null 2>&1; then
            supabase stop
          else
            echo "Supabase CLI not installed; skipping supabase stop."
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          ANALYZE: ${{ github.ref == 'refs/heads/main' && 'true' || 'false' }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: .next
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

      - name: Upload bundle analysis reports
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: |
            .next/analyze/**
            .next/BUILD_ID
          retention-days: 30
          if-no-files-found: warn
          include-hidden-files: true

      - name: Generate bundle size summary
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## Bundle Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/analyze" ]; then
            echo "âœ… Bundle analysis completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Analysis reports are available in the bundle-analysis artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Bundle analysis directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Install Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          # Use the latest stable Supabase CLI. If you need fully reproducible builds,
          # intentionally pin this to a specific, existing CLI version.
          version: 2.62.5

      - name: Start Supabase
        run: |
          # Exclude inbucket to avoid port 54324 conflicts on GitHub runners
          supabase start -x inbucket
          # Export keys to GITHUB_ENV
          STATUS=$(supabase status -o json)
          echo "Supabase Status Output: $STATUS"

          API_URL=$(echo $STATUS | jq -r .API_URL)
          ANON_KEY=$(echo $STATUS | jq -r .ANON_KEY)
          SERVICE_KEY=$(echo $STATUS | jq -r .SERVICE_ROLE_KEY)

          if [ "$API_URL" == "null" ] || [ -z "$API_URL" ] || \
             [ "$ANON_KEY" == "null" ] || [ -z "$ANON_KEY" ] || \
             [ "$SERVICE_KEY" == "null" ] || [ -z "$SERVICE_KEY" ]; then
            echo "Error: Failed to extract Supabase configuration. Status output was: $STATUS"
            exit 1
          fi

          echo "NEXT_PUBLIC_SUPABASE_URL=$API_URL" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$ANON_KEY" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=$SERVICE_KEY" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SITE_URL=http://localhost:4000" >> $GITHUB_ENV

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: next-build
          path: .next

      - name: Start Next.js server
        run: |
          pnpm start -p 4000 > server.log 2>&1 &
          echo $! > server.pid
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:4000 > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i: Server not ready yet, waiting..."
            sleep 2
          done
          echo "Server failed to start. Logs:"
          if [ -f server.log ]; then
            # Print sanitized logs to stdout
            sed -e "s|$NEXT_PUBLIC_SUPABASE_ANON_KEY|[REDACTED_ANON_KEY]|g" \
                -e "s|$SUPABASE_SERVICE_ROLE_KEY|[REDACTED_SERVICE_ROLE_KEY]|g" server.log || true
          fi
          exit 1

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4000

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            kill $PID 2>/dev/null || true
            sleep 2
            kill -9 $PID 2>/dev/null || true
            rm server.pid
          fi
          pkill -f "next start" || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos
          path: |
            test-results/**/*.webm
            test-results/**/*.mp4
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload test screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots
          path: test-results/**/*.png
          retention-days: 14
          if-no-files-found: ignore

      - name: Sanitize server logs
        if: failure()
        run: |
          if [ -f server.log ]; then
            # Redact sensitive keys from logs
            sed -e "s|$NEXT_PUBLIC_SUPABASE_ANON_KEY|[REDACTED_ANON_KEY]|g" \
                -e "s|$SUPABASE_SERVICE_ROLE_KEY|[REDACTED_SERVICE_ROLE_KEY]|g" server.log > server.log.tmp && mv server.log.tmp server.log
          fi

      - name: Upload server logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: server.log
          retention-days: 1
          if-no-files-found: ignore

  deploy-db:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    needs: [test, build, e2e-tests]
    if: github.ref == 'refs/heads/main' && success()
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF || secrets.SUPABASE_PROJECT_ID }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate Supabase secrets
        run: |
          has_missing_secrets=0
          for var in SUPABASE_ACCESS_TOKEN SUPABASE_PROJECT_REF; do
            if [ -z "${!var}" ]; then
              echo "$var is required"
              has_missing_secrets=1
            fi
          done

          if [ -z "$SUPABASE_DB_PASSWORD" ] && [ -z "$SUPABASE_DB_URL" ]; then
            echo "Error: Either SUPABASE_DB_PASSWORD or SUPABASE_DB_URL must be set as a GitHub secret"
            has_missing_secrets=1
          fi

          if [ "$has_missing_secrets" -ne 0 ]; then
            exit 1
          fi

      - uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          # Use the latest stable Supabase CLI. If you need fully reproducible builds,
          # intentionally pin this to a specific, existing CLI version.
          version: 2.62.5

      - name: Show Supabase CLI version
        run: supabase --version

      - name: Link Supabase project
        run: |
          if [ -n "$SUPABASE_DB_PASSWORD" ]; then
            supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"
          else
            supabase link --project-ref "$SUPABASE_PROJECT_REF" --db-url "$SUPABASE_DB_URL"
          fi

      - name: Dry run migrations push
        run: |
          # Fail fast if the dry run surfaces issues so the push step is skipped.
          set -euo pipefail
          supabase db push --linked --dry-run
          echo "Dry run succeeded; proceeding to push migrations."

      - name: Push migrations to production
        run: supabase db push --linked

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [build, e2e-tests, test]
    continue-on-error: true
    if: ${{ github.actor != 'dependabot[bot]' && success() }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: coverage
          path: coverage/

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 #SonarCloud v6 SHA Hash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.verbose=true

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret scanning
        uses: trufflesecurity/trufflehog@f15cb8b37b9b70056bc82a8eb7151f75fad27a71 # Validated SHA Hash for trufflehog v3.90.13
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before }}
          head: HEAD

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Vulnerability audit
        continue-on-error: true
        run: pnpm audit --audit-level=high
