name: CI/CD Pipeline

# Note: If using tj-actions/changed-files in the future, it will automatically use
# the default GITHUB_TOKEN. The current permissions (contents: read) are sufficient
# for changed-files to function correctly without explicit token passing.

permissions: {}

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

concurrency:
  group: cicd-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 20.18.0
  PNPM_VERSION: 9.15.0

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Run lint
        run: pnpm lint

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Run tests
        run: pnpm test

      - name: Upload coverage reports
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: coverage
          path: coverage/
          retention-days: 1
          if-no-files-found: warn

  validate-migrations:
    name: Validate Migrations
    runs-on: ubuntu-latest
    needs: [build]
    # Skip for draft PRs and Dependabot to avoid heavy Supabase spin-up
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft && github.actor != 'dependabot[bot]'
    permissions:
      contents: read
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          # Uses a specific version of the Supabase CLI to ensure reproducibility
          version: 2.62.5

      - name: Start Supabase
        run: |
          # Exclude inbucket to avoid port 54324 conflicts on GitHub runners
          supabase start -x inbucket

      - name: Validate migrations
        run: supabase db reset --yes

      - name: Stop Supabase
        if: ${{ always() }}
        run: |
          if command -v supabase >/dev/null 2>&1; then
            supabase stop
          else
            echo "Supabase CLI not installed; skipping supabase stop."
          fi

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    # Heavy build skips draft PRs and Dependabot but runs on pushes
    if: github.event_name != 'pull_request' || (!github.event.pull_request.draft && github.actor != 'dependabot[bot]')
    permissions:
      contents: read
      actions: write
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Restore Next.js cache
        id: next-cache
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .next/cache
            .turbo
          key: next-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'next.config.mjs', 'tsconfig.json') }}
          restore-keys: |
            next-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-

      - name: Next.js cache summary
        run: |
          echo "Next.js cache hit: ${{ steps.next-cache.outputs.cache-hit }}" >> "$GITHUB_STEP_SUMMARY"
        shell: bash

      - name: Build application
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          ANALYZE: ${{ github.ref == 'refs/heads/main' && 'true' || 'false' }}

      - name: Save Next.js cache
        if: success() && github.actor != 'dependabot[bot]' && !(github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork)
        uses: actions/cache/save@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            .next/cache
            .turbo
          key: next-cache-${{ runner.os }}-${{ env.NODE_VERSION }}-${{ hashFiles('pnpm-lock.yaml', 'next.config.js', 'next.config.mjs', 'tsconfig.json') }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: next-build
          path: .next
          retention-days: 1
          if-no-files-found: error
          include-hidden-files: true

      - name: Upload bundle analysis reports
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: bundle-analysis
          path: |
            .next/analyze/**
            .next/BUILD_ID
          retention-days: 30
          if-no-files-found: warn
          include-hidden-files: true

      - name: Generate bundle size summary
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## Bundle Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d ".next/analyze" ]; then
            echo "âœ… Bundle analysis completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¦ Analysis reports are available in the bundle-analysis artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Bundle analysis directory not found" >> $GITHUB_STEP_SUMMARY
          fi

  detect-app-changes:
    name: Detect App Changes
    runs-on: ubuntu-latest
    # Skip for draft PRs and Dependabot; still run on pushes
    if: github.event_name != 'pull_request' || (!github.event.pull_request.draft && github.actor != 'dependabot[bot]')
    permissions:
      contents: read
    outputs:
      app: ${{ steps.app-changes.outputs.app }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Detect app-impacting changes
        id: app-changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        # Gate E2E to app-related paths and critical configs/lockfiles
        with:
          filters: |
            app:
              - 'app/**'
              - 'src/**'
              - 'components/**'
              - 'config/**'
              - 'public/**'
              - 'styles/**'
              - 'lib/**'
              - 'utils/**'
              - 'supabase/migrations/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
              - 'next.config.*'
              - 'tsconfig.json'
              - '.env.example'
              - 'playwright.config.*'

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build, detect-app-changes]
    # Only run for non-draft PRs/non-Dependabot or push events
    if: (github.event_name != 'pull_request' || (!github.event.pull_request.draft && github.actor != 'dependabot[bot]')) && needs.detect-app-changes.result == 'success' && needs.detect-app-changes.outputs.app == 'true'
    permissions:
      contents: read
      actions: write
    timeout-minutes: 45
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps

      - name: Install Supabase CLI
        uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          # Use the latest stable Supabase CLI. If you need fully reproducible builds,
          # intentionally pin this to a specific, existing CLI version.
          version: 2.62.5

      - name: Start Supabase
        run: |
          # Exclude inbucket to avoid port 54324 conflicts on GitHub runners
          supabase start -x inbucket
          # Export keys to GITHUB_ENV
          STATUS=$(supabase status -o json)
          echo "Supabase Status Output: $STATUS"

          API_URL=$(echo $STATUS | jq -r .API_URL)
          ANON_KEY=$(echo $STATUS | jq -r .ANON_KEY)
          SERVICE_KEY=$(echo $STATUS | jq -r .SERVICE_ROLE_KEY)

          if [ "$API_URL" == "null" ] || [ -z "$API_URL" ] || \
             [ "$ANON_KEY" == "null" ] || [ -z "$ANON_KEY" ] || \
             [ "$SERVICE_KEY" == "null" ] || [ -z "$SERVICE_KEY" ]; then
            echo "Error: Failed to extract Supabase configuration. Status output was: $STATUS"
            exit 1
          fi

          echo "NEXT_PUBLIC_SUPABASE_URL=$API_URL" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$ANON_KEY" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=$SERVICE_KEY" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SITE_URL=http://localhost:4000" >> $GITHUB_ENV

      - name: Download build artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: next-build
          path: .next

      - name: Start Next.js server
        run: |
          pnpm start -p 4000 > server.log 2>&1 &
          echo $! > server.pid
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ env.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ env.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SITE_URL: ${{ env.NEXT_PUBLIC_SITE_URL }}

      - name: Wait for server to be ready
        run: |
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -f http://localhost:4000 > /dev/null 2>&1; then
              echo "Server is ready!"
              exit 0
            fi
            echo "Attempt $i: Server not ready yet, waiting..."
            sleep 2
          done
          echo "Server failed to start. Logs:"
          if [ -f server.log ]; then
            # Print sanitized logs to stdout
            sed -e "s|$NEXT_PUBLIC_SUPABASE_ANON_KEY|[REDACTED_ANON_KEY]|g" \
                -e "s|$SUPABASE_SERVICE_ROLE_KEY|[REDACTED_SERVICE_ROLE_KEY]|g" server.log || true
          fi
          exit 1

      - name: Run E2E tests
        run: pnpm test:e2e
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4000

      - name: Stop Next.js server
        if: always()
        run: |
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            kill $PID 2>/dev/null || true
            sleep 2
            kill -9 $PID 2>/dev/null || true
            rm server.pid
          fi
          pkill -f "next start" || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload test videos
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: playwright-videos
          path: |
            test-results/**/*.webm
            test-results/**/*.mp4
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload test screenshots
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: playwright-screenshots
          path: test-results/**/*.png
          retention-days: 14
          if-no-files-found: ignore

      - name: Sanitize server logs
        if: failure()
        run: |
          if [ -f server.log ]; then
            # Redact sensitive keys from logs
            sed -e "s|$NEXT_PUBLIC_SUPABASE_ANON_KEY|[REDACTED_ANON_KEY]|g" \
                -e "s|$SUPABASE_SERVICE_ROLE_KEY|[REDACTED_SERVICE_ROLE_KEY]|g" server.log > server.log.tmp && mv server.log.tmp server.log
          fi

      - name: Upload server logs
        if: failure()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: server-logs
          path: server.log
          retention-days: 1
          if-no-files-found: ignore

  deploy-db:
    name: Deploy Database Migrations
    runs-on: ubuntu-latest
    needs: [test, build, detect-app-changes, e2e-tests]
    # Protect production migrations to main branch and skip Dependabot
    # Require a successful detect-app-changes run; if app changes are detected, require E2E success, otherwise allow skipped E2E
    if: github.ref == 'refs/heads/main' && needs.detect-app-changes.result == 'success' && (needs.detect-app-changes.outputs.app != 'true' || needs.e2e-tests.result == 'success') && success() && github.actor != 'dependabot[bot]'
    permissions:
      contents: read
    timeout-minutes: 30
    env:
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF || secrets.SUPABASE_PROJECT_ID }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Validate Supabase secrets
        run: |
          has_missing_secrets=0
          for var in SUPABASE_ACCESS_TOKEN SUPABASE_PROJECT_REF; do
            if [ -z "${!var}" ]; then
              echo "$var is required"
              has_missing_secrets=1
            fi
          done

          if [ -z "$SUPABASE_DB_PASSWORD" ] && [ -z "$SUPABASE_DB_URL" ]; then
            echo "Error: Either SUPABASE_DB_PASSWORD or SUPABASE_DB_URL must be set as a GitHub secret"
            has_missing_secrets=1
          fi

          if [ "$has_missing_secrets" -ne 0 ]; then
            exit 1
          fi

      - uses: supabase/setup-cli@b60b5899c73b63a2d2d651b1e90db8d4c9392f51 # v1.6.0
        with:
          # Use the latest stable Supabase CLI. If you need fully reproducible builds,
          # intentionally pin this to a specific, existing CLI version.
          version: 2.62.5

      - name: Show Supabase CLI version
        run: supabase --version

      - name: Link Supabase project
        run: |
          if [ -n "$SUPABASE_DB_PASSWORD" ]; then
            supabase link --project-ref "$SUPABASE_PROJECT_REF" --password "$SUPABASE_DB_PASSWORD"
          else
            supabase link --project-ref "$SUPABASE_PROJECT_REF" --db-url "$SUPABASE_DB_URL"
          fi

      - name: Dry run migrations push
        run: |
          # Fail fast if the dry run surfaces issues so the push step is skipped.
          set -euo pipefail
          supabase db push --linked --dry-run
          echo "Dry run succeeded; proceeding to push migrations."

      - name: Push migrations to production
        run: supabase db push --linked

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: [test]
    continue-on-error: true
    # Run static analysis after coverage; skip draft PRs and Dependabot
    if: ${{ (github.event_name != 'pull_request' || !github.event.pull_request.draft) && github.actor != 'dependabot[bot]' && success() }}
    permissions:
      contents: read
      pull-requests: read
      actions: write
    timeout-minutes: 25
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Download coverage reports
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          name: coverage
          path: coverage/

      - name: Run SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarcloud.io
        with:
          projectBaseDir: .
          args: >
            -Dsonar.verbose=true
            -Dsonar.projectKey=Agile-Flimflam_happy-harvests
            -Dsonar.organization=agile-flimflam
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
            -Dsonar.sources=src

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Secret scanning
        uses: trufflesecurity/trufflehog@f15cb8b37b9b70056bc82a8eb7151f75fad27a71 # Validated SHA Hash for trufflehog v3.90.13
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before }}
          head: HEAD

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [lint, test]
    permissions:
      contents: read
      actions: write
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: Vulnerability audit
        continue-on-error: true
        run: pnpm audit --audit-level=high
